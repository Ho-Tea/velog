<blockquote>
<p><strong>ë³¸ í”„ë¡œì íŠ¸ëŠ” í† ìŠ¤ í˜ì´ë¨¼ì¸  ê²°ì œ APIë¥¼ í™œìš©í•œ ë°©íƒˆì¶œ ì˜ˆì•½ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.</strong></p>
</blockquote>
<p>í•´ë‹¹ ê¸€ì€ ì•„ë˜ì˜ <code>3ê°€ì§€ ì¡°ê±´</code>ì— ê¸°ë°˜í•˜ì—¬ ê²°ì œ API ì—°ë™ ê³¼ì •ì—ì„œ íŠ¸ëœì­ì…˜ ê´€ë¦¬, ì›ìì„± ë³´ì¥, ë°ì´í„° ë¬´ê²°ì„± í™•ë³´ ë“±ì„ ìœ„í•´ ì„ íƒí•œ ê¸°ìˆ ì  ì ‘ê·¼ ë°©ì‹ì— ëŒ€í•´ ì„¤ëª…í•©ë‹ˆë‹¤. </p>
<ul>
<li><strong>ì¡°ê±´ 1 : ê²°ì œ ë„ë©”ì¸ì˜ ê²½ìš°, ëˆì´ ì˜¤ê°€ëŠ” ë¯¼ê°í•œ íŠ¸ëœì­ì…˜ì„ ì²˜ë¦¬í•˜ë¯€ë¡œ ë°ì´í„°ì˜ ì •í™•ì„±ê³¼ ì¼ê´€ì„±ì´ ê°€ì¥ ì¤‘ìš”í•˜ë‹¤.</strong></li>
<li><strong>ì¡°ê±´ 2 : ë°©íƒˆì¶œì„ ì˜ˆì•½í•˜ëŠ” ê³¼ì •ì—ì„œ ì‚¬ìš©ìëŠ” ì¶œê¸ˆ ê²°ê³¼ì™€ ì˜ˆì•½ ê²°ê³¼ë¥¼ ì•Œê³  ë„˜ì–´ê°€ì•¼í•˜ê¸° ë•Œë¬¸ì— ë™ê¸°ë¡œ êµ¬ì„±í•´ì•¼ í•œë‹¤.</strong></li>
<li><strong>ì¡°ê±´ 3 : ì‚¬ìš©ìëŠ” ì˜ˆì•½ì´ ì¦‰ì‹œ ì™„ë£Œë˜ê¸°ë¥¼ ê¸°ëŒ€í•˜ë¯€ë¡œ Time Outì„ ì„¤ì •í•´ì•¼ í•œë‹¤.</strong></li>
</ul>
<hr />
<h1 id="ìš”ì•½">[ìš”ì•½]</h1>
<blockquote>
<p>í•´ë‹¹ ê¸€ì—ì„œëŠ” <code>ì¡°ê±´ 1</code>ê³¼ <code>ì¡°ê±´ 2</code>ë¥¼ ì¶©ì¡±í•˜ëŠ” ê³¼ì •ì„ ë‹´ê³  ìˆìœ¼ë©°, <code>ì¡°ê±´ 3</code>ì„ ì¶©ì¡±í•˜ëŠ” ê³¼ì •ì€ 
<a href="https://velog.io/@ho-tea/Connection-Pool-Starvation-%EB%B0%A9%EC%A7%80-%EC%A0%84%EB%9E%B5">ğŸ”— ê²°ì œ API - Connection Pool Starvation ë°©ì§€ ì „ëµ</a>ì—ì„œ í™•ì¸ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
</blockquote>
<p><strong>ê²°ë¡ ì ìœ¼ë¡œ <code>[í•´ê²° ë°©ì•ˆ 3 : ìƒˆë¡œìš´ êµ¬ì¡°ì— íŠ¸ëœì­ì…˜ ë¶„ë¦¬ ì „ëµ ë„ì…]</code>ì„ ì„ íƒí•˜ëŠ” ê²ƒìœ¼ë¡œ 2ê°€ì§€ ì¡°ê±´ì„ ëª¨ë‘ ì¶©ì¡±í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.</strong></p>
<hr />
<h1 id="ë¬¸ì œ-ìƒí™©">[ë¬¸ì œ ìƒí™©]</h1>
<p>ê²°ì œ APIë¥¼ ì‚¬ìš©í•˜ëŠ” ê³¼ì •ì—ì„œ <strong>ì™¸ë¶€ ê²°ì œ API í˜¸ì¶œ</strong>ê³¼ <strong>ì˜ˆì•½ ì •ë³´ &amp; ê²°ì œ ì •ë³´ DB ì €ì¥</strong> ë¡œì§ì„ í•˜ë‚˜ì˜ íŠ¸ëœì­ì…˜ìœ¼ë¡œ ê´€ë¦¬í•˜ì—¬ ë°ì´í„° ì¼ê´€ì„±ì„ ë³´ì¥í•´ì•¼ í•œë‹¤ê³  íŒë‹¨í–ˆìŠµë‹ˆë‹¤.
ê·¸ëŸ¬ë‚˜ í•˜ë‚˜ì˜ íŠ¸ëœì­ì…˜ ë‚´ì—ì„œ <strong>ì™¸ë¶€ ê²°ì œ API í˜¸ì¶œ í›„ ì˜ˆì•½ ì •ë³´ &amp; ê²°ì œ ì •ë³´ DB ì €ì¥ ë¡œì§ì„ ìˆ˜í–‰í•˜ëŠ” ê³¼ì •</strong>ì—ì„œ <strong><code>ë¬¸ì œ</code></strong>ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤.</p>
<p>(1. ì™¸ë¶€ ê²°ì œ API í˜¸ì¶œ â†’ 2. ì˜ˆì•½ ì •ë³´ &amp; ê²°ì œ ì •ë³´ DB ì €ì¥ ë¡œì§ ì‹¤í–‰ ìˆœì„œ)</p>
<pre><code class="language-java">// ReservationApplicationService.java

@Transactional
public ReservationPaymentResponse saveReservationPayment(
        LoginMember loginMember,
        ReservationPaymentRequest reservationPaymentRequest
) {
        PaymentResult paymentResult = paymentClient.purchase(reservationPaymentRequest.toPaymentRequest()); // ì™¸ë¶€ ê²°ì œ API í˜¸ì¶œ
    return reservationService.saveReservationPayment(loginMember, reservationPaymentRequest.toReservationRequest(), paymentResult); // ë‚´ë¶€ DB ì €ì¥ ë¡œì§
}
</code></pre>
<p>ì™¸ë¶€ API í˜¸ì¶œì— ì‹¤íŒ¨í•˜ë©´ <strong>ì˜ˆì•½ ì •ë³´ &amp; ê²°ì œ ì •ë³´ DB ì €ì¥</strong> ë¡œì§ì´ ì‹¤í–‰ë˜ì§€ ì•Šì•„ ì „ì²´ íŠ¸ëœì­ì…˜ì´ ë¡¤ë°±ë˜ë¯€ë¡œ ë¬¸ì œê°€ ë°œìƒí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
<p><strong>ê·¸ëŸ¬ë‚˜ ì™¸ë¶€ API í˜¸ì¶œì€ ì„±ê³µí–ˆì§€ë§Œ, ì˜ˆì•½ ì •ë³´ &amp; ê²°ì œ ì •ë³´ DB ì €ì¥ì´ ì‹¤íŒ¨</strong>í•˜ë©´ <strong><code>ë°ì´í„° ì¼ê´€ì„±</code></strong>ì´ ë³´ì¥ë˜ì§€ ì•ŠëŠ” ë¬¸ì œê°€ ë°œìƒí•˜ê²Œ ë©ë‹ˆë‹¤.</p>
<hr />
<h1 id="í•´ê²°ë°©ì•ˆ">[í•´ê²°ë°©ì•ˆ]</h1>
<h2 id="âŒ-í•´ê²°-ë°©ì•ˆ-1--ê²°ì œ-ì·¨ì†Œ-api-í˜¸ì¶œ-ë¡œì§ì„-êµ¬í˜„í•œë‹¤">âŒÂ [í•´ê²° ë°©ì•ˆ 1 : ê²°ì œ ì·¨ì†Œ API í˜¸ì¶œ ë¡œì§ì„ êµ¬í˜„í•œë‹¤.]</h2>
<h3 id="í•´ê²°-ë°©ì•ˆ-1-1--try-catch-ë¡œ-êµ¬í˜„">[í•´ê²° ë°©ì•ˆ 1-1 : <code>try-catch</code> ë¡œ êµ¬í˜„]</h3>
<pre><code class="language-java">@Transactional
public ReservationPaymentResponse saveReservationPayment(
        LoginMember loginMember,
        ReservationPaymentRequest reservationPaymentRequest
) {
    PaymentResult paymentResult = paymentClient.purchase(reservationPaymentRequest.toPaymentRequest());
    try {
        // ì˜ˆì•½ ì •ë³´ &amp; ê²°ì œ ì •ë³´ DB ì €ì¥
        return reservationService.saveReservationPayment(
                loginMember,
                reservationPaymentRequest.toReservationRequest(),
                paymentResult
        );
    } catch (Exception e) {
        // ì˜ˆì•½ ì •ë³´ &amp; ê²°ì œ ì •ë³´ DB ì €ì¥ì— ì‹¤íŒ¨í•œ ê²½ìš°, ê²°ì œ ì·¨ì†Œ ìš”ì²­ì„ ë³´ëƒ„
        paymentClient.cancel(reservationPaymentRequest.paymentKey(), new CancelReason(&quot;ê´€ë¦¬ì ê¶Œí•œ ì·¨ì†Œ&quot;));
        throw e;
    }
}</code></pre>
<h3 id="í•´ê²°-ë°©ì•ˆ-1-2--íŠ¸ëœì­ì…˜-ë™ê¸°í™”ë¥¼-í†µí•œ-ë³´ìƒ-ì²˜ë¦¬">[í•´ê²° ë°©ì•ˆ 1-2 : íŠ¸ëœì­ì…˜ ë™ê¸°í™”ë¥¼ í†µí•œ ë³´ìƒ ì²˜ë¦¬]</h3>
<pre><code class="language-java">@Transactional
public ReservationPaymentResponse saveReservationPayment(
        LoginMember loginMember,
        ReservationPaymentRequest reservationPaymentRequest
) {
    PaymentResult paymentResult = paymentClient.purchase(reservationPaymentRequest.toPaymentRequest());
    // íŠ¸ëœì­ì…˜ ë™ê¸°í™” ì½œë°±ì„ ë“±ë¡í•˜ì—¬, íŠ¸ëœì­ì…˜ì´ ë¡¤ë°±ë  ê²½ìš° ë³´ìƒ ì²˜ë¦¬(ê²°ì œ ì·¨ì†Œ)ë¥¼ ìˆ˜í–‰í•¨
    TransactionSynchronizationManager.registerSynchronization(new TransactionSynchronizationAdapter() {
        @Override
        public void afterCompletion(int status) {
            if (status == TransactionSynchronization.STATUS_ROLLED_BACK) {
                // íŠ¸ëœì­ì…˜ ë¡¤ë°± ì‹œ ê²°ì œ ì·¨ì†Œ ìš”ì²­ ìˆ˜í–‰
                try {
                    paymentClient.cancel(reservationPaymentRequest.paymentKey(), new CancelReason(&quot;ê´€ë¦¬ì ê¶Œí•œ ì·¨ì†Œ&quot;));
                } catch (Exception ex) {
                    // ë³´ìƒ ì²˜ë¦¬ ì‹¤íŒ¨ ì‹œ ë¡œê·¸ ë“±ì„ í†µí•´ ëª¨ë‹ˆí„°ë§
                    System.err.println(&quot;ê²°ì œ ì·¨ì†Œ ë³´ìƒ ì²˜ë¦¬ ì‹¤íŒ¨: &quot; + ex.getMessage());
                }
            }
        }
    });
    return reservationService.saveReservationPayment(loginMember, reservationPaymentRequest.toReservationRequest(), paymentResult);
}</code></pre>
<blockquote>
<p><strong>ë³´ìƒ íŠ¸ëœì­ì…˜ Test code</strong></p>
</blockquote>
<p><img alt="" src="https://velog.velcdn.com/images/ho-tea/post/f708fab2-b269-4c94-bbd4-20ff79f6e5c4/image.png" /></p>
<h3 id="í•´ê²°ë°©ì•ˆ-1-1-1-2-ë¡œ-í•´ê²°ì´-ê°€ëŠ¥í•œê°€">[í•´ê²°ë°©ì•ˆ 1-1, 1-2 ë¡œ í•´ê²°ì´ ê°€ëŠ¥í•œê°€?]</h3>
<ul>
<li><strong>í•´ê²°ë°©ì•ˆ 1-1 : <code>try-catch</code></strong>ë¥¼ í†µí•´ ì˜ˆì•½ ì •ë³´ &amp; ê²°ì œ ì •ë³´ DB ì €ì¥ì— ì‹¤íŒ¨í•œ ê²½ìš° ê²°ì œ ì·¨ì†Œ APIë¥¼ í˜¸ì¶œí•˜ëŠ” ë°©ì‹</li>
<li><strong>í•´ê²°ë°©ì•ˆ 1-2 : <code>TransactionSynchronizationManager</code></strong>ë¥¼ í†µí•´ íŠ¸ëœì­ì…˜ ë¡¤ë°± ì‹œ ê²°ì œ ì·¨ì†Œ APIë¥¼ í˜¸ì¶œí•˜ëŠ” ì½œë°±ì„ ë“±ë¡í•˜ëŠ” ë°©ì‹</li>
</ul>
<p>2ê°€ì§€ ë°©ì‹ ëª¨ë‘ <strong>ì™¸ë¶€ APIì˜ ê²°ì œ ì·¨ì†Œ ë¡œì§ì´ ì‹¤íŒ¨í•  ê°€ëŠ¥ì„±</strong>ì´ ìˆê¸° ë•Œë¬¸ì— ì´ ë°©ë²•ì€ ì™„ë²½í•œ í•´ê²°ì±…ì´ ì•„ë‹ˆë¼ê³  íŒë‹¨í•˜ì˜€ìŠµë‹ˆë‹¤.</p>
<hr />
<h2 id="âŒ-í•´ê²°ë°©ì•ˆ-2--êµ¬ì¡°-ê°œì„ ">âŒÂ [í•´ê²°ë°©ì•ˆ 2 : êµ¬ì¡° ê°œì„ ]</h2>
<blockquote>
<p><strong>[ìƒˆë¡œìš´ êµ¬ì¡°]</strong> 
<strong>1. ì‚¬ì „</strong> <strong>ì˜ˆì•½ ì •ë³´ &amp; ê²°ì œ ì •ë³´</strong> <strong>DB ì €ì¥
2. ì™¸ë¶€ ê²°ì œ API í˜¸ì¶œ
3. ìƒì„¸</strong> <strong>ì˜ˆì•½ ì •ë³´ &amp; ê²°ì œ ì •ë³´</strong> <strong>DB ì €ì¥</strong></p>
</blockquote>
<pre><code class="language-java">public ReservationPaymentResponse saveReservationPayment(
        LoginMember loginMember,
        ReservationPaymentRequest reservationPaymentRequest
) {
        **// 1. ì‚¬ì „ ì˜ˆì•½ ì •ë³´ &amp; ê²°ì œ ì •ë³´ DB ì €ì¥**
    Reservation reservation = reservationService.saveAdvanceReservationPayment(loginMember, reservationPaymentRequest);

        **// 2. ì™¸ë¶€ ê²°ì œ API í˜¸ì¶œ**
    PaymentResult paymentResult = paymentClient.purchase(reservationPaymentRequest.toPaymentRequest());

    **// 3. ìƒì„¸ ì˜ˆì•½ ì •ë³´ &amp; ê²°ì œ ì •ë³´ DB ì €ì¥**
    return reservationService.saveDetailedReservationPayment(reservation, paymentResult);
}</code></pre>
<p>DBì— ì™¸ë¶€ API í˜¸ì¶œì— í•„ìš”í•œ ì‚¬ì „ ì •ë³´ë¥¼ ì €ì¥í•œ í›„ APIë¥¼ í˜¸ì¶œí•˜ê³ , ê·¸ ê²°ê³¼ë¡œ ì‘ë‹µ ë°ì´í„°ë¥¼ DBì— ì—…ë°ì´íŠ¸í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ ì²˜ë¦¬í•  ìˆ˜ ìˆìœ¼ë©°, DB ì €ì¥ì— ì‹¤íŒ¨í•˜ë©´ ë°”ë¡œ ë¦¬í„´í•˜ë„ë¡ êµ¬í˜„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ ë°©ì‹ì˜ ì¥ì ì€ êµ¬í˜„ì´ ê°„ë‹¨í•˜ë‹¤ëŠ” ì ì…ë‹ˆë‹¤.</p>
<p>ê·¸ëŸ¬ë‚˜ ì´ ë°©ì‹ì—ì„œ <strong>ì‚¬ì „ ì˜ˆì•½ ì •ë³´ &amp; ê²°ì œ ì •ë³´ DB ì €ì¥</strong>ì´ ì„±ê³µí•˜ê³  ì™¸ë¶€ API í˜¸ì¶œë„ ì„±ê³µí•œ í›„, ë§ˆì§€ë§‰ <strong>ìƒì„¸ ì˜ˆì•½ ì •ë³´ &amp; ê²°ì œ ì •ë³´ DB ì €ì¥</strong>ì— ì‹¤íŒ¨í•˜ëŠ” ê²½ìš°ë¥¼ ìƒê°í•´ ë³´ë©´, </p>
<p><strong>ì„¸ ì‘ì—…ì„ ëª¨ë‘ í•˜ë‚˜ì˜ íŠ¸ëœì­ì…˜ìœ¼ë¡œ ë¬¶ì–´ë‘ë©´</strong> <strong>ë§ˆì§€ë§‰ DB í˜¸ì¶œ ì‹¤íŒ¨ ì‹œ ì™¸ë¶€ API ê²°ì œë¥¼ ë¡¤ë°±í•˜ê¸° ìœ„í•œ APIë¥¼ í˜¸ì¶œí•´ì•¼ í•˜ëŠ” ë¬¸ì œê°€ ë°œìƒí•˜ê²Œ ë©ë‹ˆë‹¤.</strong></p>
<p><strong><code>ì´ëŠ” í•´ê²°ë°©ì•ˆ 1ì—ì„œ ë°œìƒí•˜ëŠ” ë¬¸ì œì™€ ë™ì¼í•´ì§‘ë‹ˆë‹¤</code></strong>.</p>
<p><strong>ë”°ë¼ì„œ, ì„œë¡œ ë‹¤ë¥¸ íŠ¸ëœì­ì…˜ìœ¼ë¡œ ì²˜ë¦¬í•˜ëŠ” ë°©ì•ˆì„ ê³ ë ¤í•´ ë³¼ í•„ìš”ê°€ ìˆìŠµë‹ˆë‹¤.</strong></p>
<hr />
<h2 id="âœ…-í•´ê²°-ë°©ì•ˆ-3--ìƒˆë¡œìš´-êµ¬ì¡°ì—-íŠ¸ëœì­ì…˜-ë¶„ë¦¬-ì „ëµ-ë„ì…">âœ…Â [í•´ê²° ë°©ì•ˆ 3 : ìƒˆë¡œìš´ êµ¬ì¡°ì— íŠ¸ëœì­ì…˜ ë¶„ë¦¬ ì „ëµ ë„ì…]</h2>
<p>ì™¸ë¶€ ê²°ì œ API í˜¸ì¶œ ì „ì— <strong>DBì— ì˜ˆì•½/ê²°ì œ ì‚¬ì „ ì •ë³´ë¥¼ ì €ì¥í•˜ëŠ” ì‘ì—…ê³¼ ì™¸ë¶€ ê²°ì œ API í˜¸ì¶œì€ í•˜ë‚˜ì˜ íŠ¸ëœì­ì…˜</strong>ìœ¼ë¡œ ì²˜ë¦¬í•˜ê³ , ê·¸ í›„ <strong>ì˜ˆì•½/ê²°ì œ ìƒì„¸ ì •ë³´ë¥¼ ì €ì¥í•˜ëŠ” ì‘ì—…</strong>ì€ <code>ë³„ë„ì˜ íŠ¸ëœì­ì…˜ìœ¼ë¡œ ë¶„ë¦¬</code>í•˜ëŠ” ë°©ì‹ì„ ì„ íƒí•˜ì˜€ìŠµë‹ˆë‹¤.</p>
<p>(ì´ ê²½ìš°, ë§Œì•½ ì˜ˆì•½/ê²°ì œ ìƒì„¸ ì •ë³´ ì €ì¥ì— ì‹¤íŒ¨í•˜ë”ë¼ë„ í•´ë‹¹ íŠ¸ëœì­ì…˜ë§Œ ë¡¤ë°±ë˜ê³ , ì˜ˆì•½/ê²°ì œ ì‚¬ì „ ì •ë³´ëŠ” ì´ë¯¸ ì»¤ë°‹ë˜ì–´ ë‚¨ê²Œ ë©ë‹ˆë‹¤.)</p>
<pre><code class="language-java">// ReservationFacade.java

public ReservationPaymentResponse saveReservationPayment(
        LoginMember loginMember,
        ReservationPaymentRequest reservationPaymentRequest
) {
    ReservationPaymentResult reservationPaymentResult = reservationApplicationService.saveAdvanceReservationPayment(loginMember, reservationPaymentRequest);
    try {
        return reservationApplicationService.saveDetailedReservationPayment(reservationPaymentResult.reservation(), reservationPaymentResult.paymentResult());
    } catch (Exception e) {
        return new ReservationPaymentResponse(
                ReservationResponse.from(reservationPaymentResult.reservation()),
                PaymentResponse.from(reservationPaymentResult.paymentResult()));
    }
}

// ReservationApplicationService.java

**// [ì‚¬ì „ ì˜ˆì•½ ì •ë³´ &amp; ê²°ì œ ì •ë³´ DB ì €ì¥]**
@Transactional(propagation = Propagation.REQUIRES_NEW)
public ReservationPaymentResult saveAdvanceReservationPayment(LoginMember loginMember, ReservationPaymentRequest reservationPaymentRequest) {
    Reservation reservation = reservationService.saveAdvanceReservationPayment(loginMember, reservationPaymentRequest.toReservationRequest(), reservationPaymentRequest.toPaymentRequest());
    PaymentResult paymentResult = paymentClient.purchase(reservationPaymentRequest.toPaymentRequest());
    return new ReservationPaymentResult(reservation, paymentResult);
}

**// [ìƒì„¸ ì˜ˆì•½ ì •ë³´ &amp; ê²°ì œ ì •ë³´ DB ì €ì¥]**
@Transactional(propagation = Propagation.REQUIRES_NEW)
public ReservationPaymentResponse saveDetailedReservationPayment(
        Reservation reservation,
        PaymentResult paymentResult
) {
    return reservationService.confirmReservationPayment(reservation, paymentResult);
}</code></pre>
<p>ì´ì²˜ëŸ¼ ì„œë¡œ ë‹¤ë¥¸ íŠ¸ëœì­ì…˜ìœ¼ë¡œ ë¬¶ì´ê²Œ ëœë‹¤ë©´, ë§ˆì§€ë§‰ìœ¼ë¡œ <strong>ìƒì„¸ ì˜ˆì•½ ì •ë³´ &amp; ê²°ì œ ì •ë³´ DB ì €ì¥</strong> ë¡œì§ì´ ì‹¤íŒ¨í•˜ë”ë¼ë„ íšŒì›ì˜ ì˜ˆì•½ ë‚´ì—­ì´ ì´ë¯¸ ì €ì¥ë˜ì–´ ìˆì–´ ë‹¹ì¥ ì„œë¹„ìŠ¤ ì œê³µì—ëŠ” ë¬¸ì œê°€ ë°œìƒí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
<ul>
<li><input checked="" disabled="" type="checkbox" /> <strong>ê²°ì œ ë„ë©”ì¸ì˜ ê²½ìš°, ëˆì´ ì˜¤ê°€ëŠ” ë¯¼ê°í•œ íŠ¸ëœì­ì…˜ì„ ì²˜ë¦¬í•˜ë¯€ë¡œ ë°ì´í„°ì˜ ì •í™•ì„±ê³¼ ì¼ê´€ì„±ì´ ê°€ì¥ ì¤‘ìš”í•˜ë‹¤.</strong></li>
</ul>
<p><strong>â†’ <code>íŠ¸ëœì­ì…˜ ë¶„ë¦¬ ì „ëµ</code></strong></p>
<ul>
<li><input checked="" disabled="" type="checkbox" /> <strong>ë°©íƒˆì¶œì„ ì˜ˆì•½í•˜ëŠ” ê³¼ì •ì—ì„œ ì‚¬ìš©ìëŠ” ì¶œê¸ˆ ê²°ê³¼ì™€ ì˜ˆì•½ ê²°ê³¼ë¥¼ ì•Œê³  ë„˜ì–´ê°€ì•¼í•˜ê¸° ë•Œë¬¸ì— ë™ê¸°ë¡œ êµ¬ì„±í•´ì•¼ í•œë‹¤.</strong></li>
</ul>
<p><strong>â†’ <code>ëª¨ë“  ì‘ì—…ì„ ë™ê¸° ë°©ì‹ìœ¼ë¡œ êµ¬ì„±</code></strong></p>
<p>ì´ì™€ ê°™ì€ ìƒí™©ì—ì„œëŠ” ì™¸ë¶€ ê²°ì œ DBì™€ ë‚´ë¶€ DB ê°„ì˜ ìƒíƒœë¥¼ ì •ê¸°ì ìœ¼ë¡œ ë¹„êµí•˜ì—¬, ìƒì„¸ ì •ë³´ê°€ ì˜¬ë°”ë¥´ê²Œ ì €ì¥ë˜ì§€ ì•Šì•„ ë¶ˆì¼ì¹˜ê°€ ë°œìƒí•  ê²½ìš° ì´ë¥¼ ì‹ ì†í•˜ê²Œ ê°ì§€í•˜ê³  í•´ê²°í•  ìˆ˜ ìˆëŠ” <strong>ìƒíƒœ í™•ì¸ ë° ë³µêµ¬ ë©”ì»¤ë‹ˆì¦˜</strong>ì„ ë§ˆë ¨í•˜ëŠ” ê²ƒì´ ì¤‘ìš”í•˜ë‹¤ê³  íŒë‹¨í•˜ì˜€ìŠµë‹ˆë‹¤. </p>
<p>ë˜í•œ, ì™¸ë¶€ APIë¥¼ ì‚¬ìš©í•  ë•Œ ì˜ˆìƒí•œ ì‘ë‹µê°’ì„ ê¸°ë°˜ìœ¼ë¡œ ì •ìƒì ìœ¼ë¡œ ë¡œì§ì´ ìˆ˜í–‰ë˜ëŠ”ì§€ í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í•˜ëŠ” ê²ƒì´ í•„ìˆ˜ì ì´ë¼ê³  íŒë‹¨í•˜ì˜€ìŠµë‹ˆë‹¤.</p>
<hr />
<h3 id="âœ…-ìƒíƒœ-í™•ì¸-ë°-ë³µêµ¬-ë§¤ì»¤ë‹ˆì¦˜---scheduler">âœ…Â [ìƒíƒœ í™•ì¸ ë° ë³µêµ¬ ë§¤ì»¤ë‹ˆì¦˜ - Scheduler]</h3>
<pre><code class="language-java">@Scheduled(cron = &quot;0 0 3 * * *&quot;)
public void checkPaymentConsistency() {
    log.info(&quot;ê²°ì œ ì¼ê´€ì„± ê²€ì‚¬ ì‹œì‘ ì‹œê°: {}&quot;, LocalDateTime.now());
    List&lt;Reservation&gt; pendingReservations = reservationService.findPendingDetailedPayments();

    pendingReservations.forEach(
            reservation -&gt; {
                try {
                    Payment payment = paymentRepository.findByReservationId(reservation.getId())
                            .orElseThrow(() -&gt; new RoomescapeException(NOT_FOUND_RESERVATION_PAYMENT, reservation.getId()));
                    PaymentResult paymentResult = paymentClient.lookup(payment.getPaymentKey());
                    if (paymentResult.paymentKey().equals(payment.getPaymentKey())) {
                        reservationService.confirmReservationPayment(reservation, paymentResult);
                    }
                } catch (Exception ex) {
                    log.error(&quot;ì˜ˆì•½ë²ˆí˜¸ {} ê²°ì œ ì¼ê´€ì„± ê²€ì‚¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {}&quot;, reservation.getId(), ex.getMessage(), ex);
                }
            }
    );
    log.info(&quot;ê²°ì œ ì¼ê´€ì„± ê²€ì‚¬ ì™„ë£Œ ì‹œê°: {}&quot;, LocalDateTime.now());
}</code></pre>
<ul>
<li>ìƒíƒœ í™•ì¸ ë° ë³µêµ¬ ë©”ì»¤ë‹ˆì¦˜ì€ ìŠ¤ì¼€ì¤„ëŸ¬ë¥¼ í†µí•´ êµ¬í˜„í•˜ì˜€ìŠµë‹ˆë‹¤. ì‚¬ëŒì´ ê°€ì¥ ì ê²Œ ì´ìš©í•˜ëŠ” ìƒˆë²½ 3ì‹œì— ì¼ê´€ì„± ë³´ì¥ ì‘ì—…ì´ ìˆ˜í–‰ë˜ë„ë¡ êµ¬ì„±í•˜ì˜€ê³ , ë§ˆì§€ë§‰ìœ¼ë¡œ ë‚´ë¶€ DB ì •ë³´ ì—…ë°ì´íŠ¸ ë¡œì§ì´ ì‹¤íŒ¨í•œ ì‹œì ì„ ì¶”ì í•  ìˆ˜ ìˆë„ë¡ ê´€ë ¨ ë¡œê·¸ë¥¼ ê¸°ë¡í•˜ê³  ìˆìŠµë‹ˆë‹¤.</li>
</ul>
<hr />
<h3 id="âœ…-ì™¸ë¶€-ê²°ì œ-api-í…ŒìŠ¤íŠ¸">âœ… [ì™¸ë¶€ ê²°ì œ API í…ŒìŠ¤íŠ¸]</h3>
<pre><code class="language-java">@DisplayName(&quot;ì í•©í•œ ì¸ìë¥¼ í†µí•œ ê²°ì œ ìš”ì²­ ì‹œ ì„±ê³µí•œë‹¤.&quot;)
@Test
void purchase() throws JsonProcessingException {
    String endPoint = &quot;/v1/payments/confirm&quot;;
    mockServer
            .expect(requestTo(url + endPoint))
            .andExpect(content().json(objectMapper.writeValueAsString(PAYMENT_REQUEST)))
            .andExpect(method(HttpMethod.POST))
            .andRespond(withSuccess(objectMapper.writeValueAsString(PAYMENT_INFO), MediaType.APPLICATION_JSON));

    assertThat(tossPaymentClient.purchase(PAYMENT_REQUEST)).isEqualTo(PAYMENT_INFO);
    mockServer.verify();
}</code></pre>
<ul>
<li><code>MockRestServiceServer</code>ë¥¼ í™œìš©í•´ ì™¸ë¶€ API í˜¸ì¶œì„ ëª¨í‚¹í•˜ì˜€ìŠµë‹ˆë‹¤. ì´ë¥¼ í†µí•´ ì‹¤ì œ ì™¸ë¶€ APIì— ì˜ì¡´í•˜ì§€ ì•Šê³ ë„ ì˜ˆìƒí•œ ì‘ë‹µì„ ê¸°ë°˜ìœ¼ë¡œ í…ŒìŠ¤íŠ¸ í™˜ê²½ì„ êµ¬ì¶•í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.</li>
</ul>
<hr />
<h1 id="ê²°ë¡ ">[ê²°ë¡ ]</h1>
<p>ê²°ë¡ ì ìœ¼ë¡œ, ë³¸ í”„ë¡œì íŠ¸ì—ì„œëŠ” ê²°ì œ ë„ë©”ì¸ì—ì„œ ìš”êµ¬ë˜ëŠ” <strong>ë°ì´í„° ì •í™•ì„±ê³¼ ê°•í•œ ì¼ê´€ì„±</strong>ì„ ë³´ì¥í•˜ê¸° ìœ„í•´ ê¸°ì¡´ì˜ ë‹¨ì¼ íŠ¸ëœì­ì…˜ ë°©ì‹ ëŒ€ì‹  <strong>íŠ¸ëœì­ì…˜ ë¶„ë¦¬ ì „ëµ</strong>ì„ ë„ì…í•˜ì˜€ìŠµë‹ˆë‹¤. ì´ë¥¼ í†µí•´ ì™¸ë¶€ ê²°ì œ API í˜¸ì¶œê³¼ ì˜ˆì•½,ê²°ì œ ì •ë³´ì˜ ìƒì„¸ ì €ì¥ ì‘ì—…ì„ ë³„ë„ì˜ íŠ¸ëœì­ì…˜ìœ¼ë¡œ ë¶„ë¦¬í•¨ìœ¼ë¡œì¨, ì™¸ë¶€ API í˜¸ì¶œ í›„ DB ì €ì¥ ê³¼ì •ì—ì„œ ë°œìƒí•  ìˆ˜ ìˆëŠ” ì˜¤ë¥˜ë¡œ ì¸í•œ ë°ì´í„° ë¶ˆì¼ì¹˜ë¥¼ íš¨ê³¼ì ìœ¼ë¡œ ë°©ì§€í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.</p>
<p>ë˜í•œ, ìƒíƒœ í™•ì¸ ë° ë³µêµ¬ ë©”ì»¤ë‹ˆì¦˜ì„ ìŠ¤ì¼€ì¤„ëŸ¬ë¥¼ í†µí•´ ì£¼ê¸°ì ìœ¼ë¡œ ì‹¤í–‰í•¨ìœ¼ë¡œì¨, ë‚´ë¶€ DBì™€ ì™¸ë¶€ ê²°ì œ ìƒíƒœì˜ ë¶ˆì¼ì¹˜ ìƒí™©ì„ ê°ì§€í•˜ê³  ë³´ì™„í•  ìˆ˜ ìˆë„ë¡ í•˜ì˜€ìŠµë‹ˆë‹¤.</p>
<p>ì´ëŸ¬í•œ ê¸°ìˆ ì  ì ‘ê·¼ ë°©ì‹ì€ ê²°ì œ, ì˜ˆì•½ ë“± ë¯¼ê°í•œ íŠ¸ëœì­ì…˜ì´ í¬í•¨ëœ ë„ë©”ì¸ì—ì„œ ì‚¬ìš©ìì—ê²Œ ì‹ ë¢°ë°›ëŠ” ì„œë¹„ìŠ¤ë¥¼ ì œê³µí•˜ê¸° ìœ„í•œ í•„ìˆ˜ ìš”ì†Œë¡œ, ì˜¬ë°”ë¥¸ ì„œë¹„ìŠ¤ ì œê³µê³¼ ë°ì´í„° ë¬´ê²°ì„±ì„ ë™ì‹œì— í™•ë³´í•  ìˆ˜ ìˆëŠ” í•´ê²°ì±…ì´ë¼ê³  ìƒê°ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
<p>ì‚¬ìš©ì ê´€ì ì—ì„œëŠ” <strong><code>ê°•í•œ ì¼ê´€ì„±</code></strong>ì„ ì œê³µí•˜ë©´ì„œ ë‚´ë¶€ì ìœ¼ë¡œëŠ” ë…ë¦½ì ì¸ íŠ¸ëœì­ì…˜ê³¼ í›„ì† ë³´ì • ê³¼ì •ì„ í†µí•´ <strong><code>ìµœì¢… ì¼ê´€ì„±</code></strong> ë‹¬ì„±</p>
<p>ê°•í•œ ì¼ê´€ì„±ì„ ë§¤ ìˆœê°„ ë³´ì¥í•˜ë ¤ë©´ ì‹œìŠ¤í…œì˜ <strong>í™•ì¥ì„±ì´ë‚˜ ê°€ìš©ì„±ì´ í¬ê²Œ ì €í•´ë  ìˆ˜ ìˆê¸° ë•Œë¬¸ì—</strong>, ì¼ë¶€ ê²½ìš°ì—ëŠ” <code>ì•½ê°„ì˜ ì§€ì—° í›„ì—</code> ëª¨ë“  ë°ì´í„°ê°€ ì¼ê´€ëœ ìƒíƒœì— ë„ë‹¬í•˜ëŠ” <strong>ìµœì¢… ì¼ê´€ì„±</strong>ì„ ì„ íƒí•˜ëŠ” ê²ƒì´ í˜„ì‹¤ì ì¸ íƒ€í˜‘ì ì´ë¼ê³  ìƒê°ë©ë‹ˆë‹¤.</p>